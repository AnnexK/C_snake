#ifndef SNAKE_H_SNAKE
#define SNAKE_H_SNAKE

#include <stdlib.h>
#include "deque.h"

typedef struct
{
    signed y, x;    
} vector;

typedef struct
{
    deque *snk;
    unsigned len;
    vector direction;
} Snake;


typedef struct gd
{
    Snake *S;
    data food;

    void (*mv)(Snake *);
    void (*grow)(Snake *);
    int (*checkcol)(struct gd *);

    unsigned score;
    unsigned fieldY, fieldX;
} GameData;

/* createSnake: creates a snake in a left upper corner with size of 3, directed to the right */
Snake *createSnake(void)
{
    Snake *ret = malloc(sizeof(Snake));

    ret->len = 3;
    ret->direction.y = 0;
    ret->direction.x = 1;

    ret->snk = malloc(sizeof(deque));
    *(ret.snk) = initDeque();

    data app = {1, 1};
    for (int i = 1; i < 4; i++)
    {
	prepend(ret.snk, app);
	(app.x)++;
    }

    return ret;
}

void moveSnake(Snake *S)
{
    data newHead = {S->snk->head->d->y, S->snk->head->d->x};
    newHead.y += (S->direction).y;
    newHead.x += (S->direction).x;

    data *toFree = popTail(S->snk);
    free(toFree);

    prepend(S->snk, newHead);
}

void growSnake(Snake *S)
{
    data *oldTail = popTail(S->snk);
    data *oldPreTail = popTail(S->snk);

    vector newVec = {(signed)(oldTail->y - oldPreTail->y), (signed)(oldTail->x - oldPreTail->x)};
    data newTail = {oldTail->y + newVec.y, oldTail->x + newVec.x};

    append(S->snk, *oldPreTail);
    append(S->snk, *oldTail);
    append(S->snk, newTail);

    free(oldTail);
    free(oldPreTail);
}

/* isCollision: checks whether there is a collision of snake cells */
int isCollision(GameData *gd)
{
    data head = {gd->S->snk->head->d->y, gd->S->snk->head->d->x};
    if (head.y < 1 || head.x < 1 || head.y >= gd->fieldY || head.x >= gd->fieldX) return -1;
    
    for (dnptr cell = gd->S->snk->head->next; cell; cell = cell->next)
    {
	if (head.y == cell->d->y && head.x == cell->d->x)
	    return 1;
    }
    return 0;
}

void deleteSnake(Snake *S)
{
    killDeque(S->snk);
    S->len = 0;
    (S->direction).y = 0;
    (S->direction).x = 0;
}
#endif
